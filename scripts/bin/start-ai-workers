#!/bin/bash
set -euo pipefail
# ğŸ¤– AIçµ„ç¹”ãƒ¯ãƒ¼ã‚«ãƒ¼å®Œå…¨èµ·å‹•ã‚·ã‚¹ãƒ†ãƒ 

# ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆO3æ¨å¥¨: ç’°å¢ƒä¾å­˜æ’é™¤ï¼‰
PROJECT_ROOT="${PROJECT_ROOT:-$(realpath "$(dirname "$0")")}"
export CLAUDE_HOOKS="$PROJECT_ROOT/scripts/hooks"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆç¢ºèª
if [[ ! -f "$PROJECT_ROOT/.claude/settings.json" ]]; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"
    echo "ç¾åœ¨ä½ç½®: $(pwd)"
    echo "PROJECT_ROOT: $PROJECT_ROOT"
    exit 1
fi

cd "$PROJECT_ROOT"

echo "ğŸ‘‘ AIçµ„ç¹”ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­..."

# multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªãƒ»ä½œæˆ
if ! tmux has-session -t multiagent 2>/dev/null; then
    echo "ğŸ“± multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆä¸­..."
    tmux new-session -d -s multiagent -c "$(pwd)"
    
    # 4åˆ†å‰²ç”»é¢ä½œæˆ
    tmux split-window -t multiagent -h -c "$(pwd)"
    tmux split-window -t multiagent:0.1 -v -c "$(pwd)"  
    tmux split-window -t multiagent:0.0 -v -c "$(pwd)"
    
    echo "âœ… 4åˆ†å‰²ç”»é¢æ§‹ç¯‰å®Œäº†"
else
    echo "âœ… multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³æ—¢å­˜"
fi

# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼è¨­å®š
echo "ğŸ¨ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼è¨­å®šä¸­..."
tmux set-option -g status-position top
tmux set-option -g status-left "#[bg=colour4,fg=colour15,bold] ğŸ¤–AIçµ„ç¹”ã‚·ã‚¹ãƒ†ãƒ  #[default]"
tmux set-option -g status-right "#[bg=colour2,fg=colour15] %H:%M:%S #[default]"
tmux set-option -g status-style "bg=colour233,fg=colour15"

# å„ãƒ¯ãƒ¼ã‚«ãƒ¼ã«Claude Codeèµ·å‹•
echo "ğŸš€ å„ãƒ¯ãƒ¼ã‚«ãƒ¼ã«Claude Codeèµ·å‹•ä¸­..."

# Claudeå®Ÿè¡Œç¢ºèª
if ! command -v claude &> /dev/null; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: claude ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    echo "Claude CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"
    exit 1
fi

for i in {0..3}; do
    echo "  Pane $i: Claude Codeèµ·å‹•..."
    tmux send-keys -t multiagent:0.$i "cd $PROJECT_ROOT && claude --dangerously-skip-permissions" C-m
    sleep 2
done

echo ""
echo "âœ… AIçµ„ç¹”ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†"
echo ""
echo "ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³:"
echo "- multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³: ç¨¼åƒä¸­"
echo "- ãƒ¯ãƒ¼ã‚«ãƒ¼æ•°: 4ç”»é¢ (Pane 0-3)"
echo "- å„ãƒ¯ãƒ¼ã‚«ãƒ¼: Claude Code --dangerously-skip-permissions"
echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼: ğŸ¤–AIçµ„ç¹”ã‚·ã‚¹ãƒ†ãƒ è¡¨ç¤º"
echo ""
echo "ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
echo "1. tmux attach -t multiagent ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¥ç¶š"
echo "2. å„ãƒšã‚¤ãƒ³ã§PRESIDENTå®£è¨€å®Ÿè¡Œ"
echo "3. å½¹è·åˆ†æ‹…ãƒ»ã‚¿ã‚¹ã‚¯é…å¸ƒé–‹å§‹"
echo ""
echo "ğŸ“‹ ç”»é¢åˆ‡ã‚Šæ›¿ãˆ:"
echo "- Ctrl+b â†’ 0,1,2,3 (å„ãƒšã‚¤ãƒ³ç§»å‹•)"
echo "- Ctrl+b â†’ d (ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡æ–­)"