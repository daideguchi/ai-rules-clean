#!/usr/bin/env python3
"""
ã‚¹ãƒãƒ¼ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªã‚·ã‚¹ãƒ†ãƒ  - ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹çµ±åˆç‰ˆ
æ®µéšçš„ç¢ºèª + ã‚­ãƒ£ãƒƒã‚·ãƒ¥ + è‡ªå‹•åŒ– + è»½é‡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
"""

import json
import os
import subprocess
import time
from datetime import datetime, timedelta
from pathlib import Path

class SmartSessionChecker:
    def __init__(self):
        self.project_root = Path.cwd()
        self.cache_file = self.project_root / "runtime" / "session_check_cache.json"
        self.cache_validity = timedelta(minutes=30)  # 30åˆ†é–“æœ‰åŠ¹
        
        # ç¢ºèªãƒ¬ãƒ™ãƒ«å®šç¾©
        self.check_levels = {
            "SIMPLE": {
                "checks": ["cursor_rules", "president_status"],
                "cache_duration": 30,  # 30åˆ†
                "template": "quick"
            },
            "MEDIUM": {
                "checks": ["cursor_rules", "president_status", "system_status", "recent_violations"],
                "cache_duration": 15,  # 15åˆ†
                "template": "standard" 
            },
            "COMPLEX": {
                "checks": ["cursor_rules", "president_status", "system_status", "violations", "memory_state"],
                "cache_duration": 5,   # 5åˆ†
                "template": "detailed"
            },
            "CRITICAL": {
                "checks": ["full_audit"],
                "cache_duration": 0,   # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—
                "template": "complete"
            }
        }
    
    def load_cache(self):
        """ã‚­ãƒ£ãƒƒã‚·ãƒ¥èª­ã¿è¾¼ã¿"""
        if self.cache_file.exists():
            try:
                with open(self.cache_file, 'r') as f:
                    cache = json.load(f)
                    
                # æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
                cache_time = datetime.fromisoformat(cache.get('timestamp', '2000-01-01'))
                if datetime.now() - cache_time < self.cache_validity:
                    return cache
            except:
                pass
        return {}
    
    def save_cache(self, results):
        """ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜"""
        cache_data = {
            "timestamp": datetime.now().isoformat(),
            "results": results
        }
        
        self.cache_file.parent.mkdir(parents=True, exist_ok=True)
        with open(self.cache_file, 'w') as f:
            json.dump(cache_data, f, indent=2)
    
    def check_cursor_rules(self, force=False):
        """Cursor Rulesç¢ºèª"""
        cache_key = "cursor_rules"
        cached = self.load_cache()
        
        if not force and cache_key in cached.get('results', {}):
            return cached['results'][cache_key]
        
        try:
            globals_path = self.project_root / "src" / "cursor-rules" / "globals.mdc"
            if globals_path.exists():
                content = globals_path.read_text()
                if "çµ¶å¯¾ç¦æ­¢ãƒ«ãƒ¼ãƒ«" in content and "Function-Based Grouping" in content:
                    return {"status": "âœ…", "details": "180è¡Œãƒ«ãƒ¼ãƒ«ç¢ºèªæ¸ˆã¿", "violations": 0}
            
            return {"status": "âŒ", "details": "cursor-rulesæœªç¢ºèª", "violations": 1}
        except Exception as e:
            return {"status": "âš ï¸", "details": f"ç¢ºèªã‚¨ãƒ©ãƒ¼: {e}", "violations": 1}
    
    def check_president_status(self, force=False):
        """PRESIDENTçŠ¶æ…‹ç¢ºèª"""
        cache_key = "president_status"
        cached = self.load_cache()
        
        if not force and cache_key in cached.get('results', {}):
            return cached['results'][cache_key]
        
        try:
            session_file = self.project_root / "runtime" / "secure_state" / "president_session.json"
            if session_file.exists():
                session_data = json.loads(session_file.read_text())
                if session_data.get('president_declared') == True:
                    return {"status": "âœ…", "details": "PRESIDENTå®£è¨€æ¸ˆã¿", "violations": 0}
            
            return {"status": "âŒ", "details": "PRESIDENTå®£è¨€å¿…è¦", "violations": 1}
        except Exception as e:
            return {"status": "âš ï¸", "details": f"ç¢ºèªã‚¨ãƒ©ãƒ¼: {e}", "violations": 1}
    
    def check_system_status(self, force=False):
        """ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ç¢ºèª"""
        cache_key = "system_status"
        cached = self.load_cache()
        
        if not force and cache_key in cached.get('results', {}):
            return cached['results'][cache_key]
        
        try:
            result = subprocess.run(
                ["python3", "scripts/hooks/system_status_display.py"],
                capture_output=True, text=True, timeout=10
            )
            
            if result.returncode == 0:
                output = result.stdout
                if "âœ…" in output and "âŒ" not in output:
                    return {"status": "âœ…", "details": "ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸", "violations": 0}
                else:
                    return {"status": "âš ï¸", "details": "ã‚·ã‚¹ãƒ†ãƒ è­¦å‘Šã‚ã‚Š", "violations": 1}
            
            return {"status": "âŒ", "details": "ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªå¤±æ•—", "violations": 1}
        except Exception as e:
            return {"status": "âš ï¸", "details": f"ç¢ºèªã‚¨ãƒ©ãƒ¼: {e}", "violations": 1}
    
    def check_recent_violations(self, force=False):
        """æœ€è¿‘ã®é•åç¢ºèª"""
        cache_key = "recent_violations"
        cached = self.load_cache()
        
        if not force and cache_key in cached.get('results', {}):
            return cached['results'][cache_key]
        
        try:
            violations_file = self.project_root / "runtime" / "thinking_violations.json"
            if violations_file.exists():
                violations = json.loads(violations_file.read_text())
                total = violations.get('total_violations', 0)
                
                if total == 0:
                    return {"status": "âœ…", "details": "é•åè¨˜éŒ²ãªã—", "violations": 0}
                elif total <= 5:
                    return {"status": "âš ï¸", "details": f"é•å{total}ä»¶", "violations": total}
                else:
                    return {"status": "âŒ", "details": f"é‡å¤§é•å{total}ä»¶", "violations": total}
            
            return {"status": "âœ…", "details": "é•åè¨˜éŒ²ãƒ•ã‚¡ã‚¤ãƒ«ãªã—", "violations": 0}
        except Exception as e:
            return {"status": "âš ï¸", "details": f"ç¢ºèªã‚¨ãƒ©ãƒ¼: {e}", "violations": 1}
    
    def generate_template(self, level, results):
        """å¿œç­”ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ"""
        total_violations = sum(r.get('violations', 0) for r in results.values())
        
        if level == "SIMPLE":
            return f"""ğŸ” **Quick Check** 
âœ… Rules: cursor{results.get('cursor_rules', {}).get('status', 'â“')} president{results.get('president_status', {}).get('status', 'â“')}
âœ… Status: violations:{total_violations} mode:{level}"""
        
        elif level == "MEDIUM":
            return f"""ğŸ” **Standard Check**
âœ… Rules: cursor{results.get('cursor_rules', {}).get('status', 'â“')} president{results.get('president_status', {}).get('status', 'â“')}
âœ… System: {results.get('system_status', {}).get('status', 'â“')} violations:{total_violations}
âœ… Mode: {level} â†’ proceed"""
        
        elif level == "COMPLEX":
            status_summary = " ".join([f"{k}:{v.get('status', 'â“')}" for k, v in results.items()])
            return f"""ğŸ“Š **Detailed Check**
{status_summary}
Total violations: {total_violations}
Mode: {level} â†’ detailed analysis"""
        
        else:  # CRITICAL
            return f"""ğŸ”´ **Complete Audit**
PRESIDENTç¢ºèª: {results.get('president_status', {}).get('details', 'Unknown')}
ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³: {results.get('system_status', {}).get('details', 'Unknown')}
è¨˜éŒ²ãƒ­ã‚°ç¢ºèª: é•å{total_violations}ä»¶
Mode: {level} â†’ full compliance"""
    
    def smart_check(self, task_level="SIMPLE", force_refresh=False):
        """ã‚¹ãƒãƒ¼ãƒˆç¢ºèªå®Ÿè¡Œ"""
        if task_level not in self.check_levels:
            task_level = "SIMPLE"
        
        config = self.check_levels[task_level]
        results = {}
        
        # å„ç¢ºèªé …ç›®å®Ÿè¡Œ
        for check_name in config["checks"]:
            if check_name == "cursor_rules":
                results[check_name] = self.check_cursor_rules(force_refresh)
            elif check_name == "president_status":
                results[check_name] = self.check_president_status(force_refresh)
            elif check_name == "system_status":
                results[check_name] = self.check_system_status(force_refresh)
            elif check_name == "recent_violations":
                results[check_name] = self.check_recent_violations(force_refresh)
            elif check_name == "full_audit":
                # CRITICALæ™‚ã¯å…¨é …ç›®å¼·åˆ¶å®Ÿè¡Œ
                results.update({
                    "cursor_rules": self.check_cursor_rules(True),
                    "president_status": self.check_president_status(True),
                    "system_status": self.check_system_status(True),
                    "violations": self.check_recent_violations(True)
                })
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ï¼ˆCRITICALä»¥å¤–ï¼‰
        if task_level != "CRITICAL":
            self.save_cache(results)
        
        # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
        template = self.generate_template(task_level, results)
        
        return {
            "level": task_level,
            "results": results,
            "template": template,
            "violations": sum(r.get('violations', 0) for r in results.values()),
            "success": all(r.get('status') in ['âœ…', 'âš ï¸'] for r in results.values())
        }

def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    import argparse
    
    parser = argparse.ArgumentParser(description="ã‚¹ãƒãƒ¼ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª")
    parser.add_argument("--level", choices=["SIMPLE", "MEDIUM", "COMPLEX", "CRITICAL"], 
                       default="SIMPLE", help="ç¢ºèªãƒ¬ãƒ™ãƒ«")
    parser.add_argument("--force", action="store_true", help="ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡è¦–")
    parser.add_argument("--template-only", action="store_true", help="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã¿å‡ºåŠ›")
    args = parser.parse_args()
    
    checker = SmartSessionChecker()
    result = checker.smart_check(args.level, args.force)
    
    if args.template_only:
        print(result["template"])
    else:
        print("ğŸ§  Smart Session Check")
        print("=" * 30)
        print(f"Level: {result['level']}")
        print(f"Violations: {result['violations']}")
        print(f"Success: {result['success']}")
        print("\nTemplate:")
        print(result["template"])
        
        if result['violations'] > 0:
            print("\nâš ï¸ é•åæ¤œå‡º - è©³ç´°ç¢ºèªæ¨å¥¨")

if __name__ == "__main__":
    main()